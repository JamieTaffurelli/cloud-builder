{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "resourceName": {
        "type": "string",
        "metadata": { "description": "The name of the virtual machine that you wish to create." }
      },
      "apiVersion": {
        "type": "string",
        "defaultValue": "2017-03-30",
        "metadata": { "description": "The version of ARM API to call" }
      },
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "allowedValues": [ "North Europe", "West Europe" ],
        "metadata": { "description": "Set this to the same location as the resource group" }
      },
      "userName": {
        "type": "string",
        "metadata": { "description": "The username of the local admin, this should be the name of the secret in key vault" }
      },
      "keyVaultName": {
        "type": "string",
        "metadata": { "description": "The key vault in which the password secret resides" }
      },
      "provisionVmAgent": {
        "type": "string",
        "defaultValue": "true",
        "allowedValues": [ "true", "false" ],
        "metadata": { "description": "Whether the VM should have the Azure agent on it" }
      },
      "vmSize": {
        "type": "string",
        "defaultValue": "Standard_A0",
        "allowedValues": [
          "Standard_A0",
          "Standard_A1",
          "Standard_A2",
          "Standard_A2_v2",
          "Standard_DS2",
          "Standard_DS2_v2",
          "Basic_A2",
          "Standard_DS3_v2",
          "Standard_D2",
          "Standard_D12",
          "Standard_D11_v2_Promo",
          "Standard_D12_v2_Promo",
          "Standard_D2_v2",
          "Standard_D2_v3",
          "Standard_DS12_v2_Promo"
        ],
        "metadata": { "description": "The VM size" }
      },
      "publisher": {
        "type": "string",
        "defaultValue": "MicrosoftWindowsServer",
        "allowedValues": [ "MicrosoftWindowsServer" ],
        "metadata": { "description": "Publisher of disk image" }
      },
      "offer": {
        "type": "string",
        "defaultValue": "WindowsServer",
        "allowedValues": [ "WindowsServer"],
        "metadata": { "description": "Offer of disk image" }
      },
      "sku": {
        "type": "string",
        "defaultValue": "2016-Datacenter",
        "allowedValues": [ "2016-Datacenter", "2012-R2-Datacenter" ],
        "metadata": { "description": "Sku of disk image" }
      },
      "version": {
        "type": "string",
        "defaultValue": "Latest",
        "allowedValues": [ "Latest" ],
        "metadata": { "description": "Version of disk image" }
      },
      "osType": {
        "type": "string",
        "defaultValue": "Windows",
        "allowedValues": [ "Windows", "Linux" ],
        "metadata": { "description": "Type of OS disk" }
      },
      "caching": {
        "type": "string",
        "defaultValue": "ReadWrite",
        "allowedValues": [ "ReadWrite", "ReadOnly", "None" ],
        "metadata": { "description": "The caching permission of the disk" }
      },
      "diskStorageAccountType": {
        "type": "string",
        "defaultValue": "Standard_LRS",
        "allowedValues": [ "Standard_LRS", "Premium_LRS", "Standard_GRS" ],
        "metadata": { "description": "Type of storage for the disk" }
      },
      "createOption": {
        "type": "string",
        "defaultValue": "FromImage",
        "allowedValues": [ "Attach", "FromImage", "Empty" ],
        "metadata": { "description": "The method to use to create and attach the disk" }
      },
      "bootDiagnosticsEnabled": {
        "type": "string",
        "defaultValue": "true",
        "allowedValues": [ "true", "false" ],
        "metadata": { "description": "Enable boot diagnostics" }
      },
      "diagnosticStorageAccount": {
        "type": "string",
        "metadata": { "description": "The storage account to place boot diagnostics" }
      },
      "nic1": {
        "type": "string",
        "metadata": { "description": "Name of network interface to attach" }
      },
      "nic1IsPrimary": {
        "type": "string",
        "defaultValue": "true",
        "allowedValues": [ "true", "false" ],
        "metadata": { "description": "Specify whether it is the primary nic" }
      },
      "nic2": {
        "type": "string",
        "metadata": { "description": "Name of network interface to attach" }
      },
      "nic2IsPrimary": {
        "type": "string",
        "defaultValue": "false",
        "allowedValues": [ "true", "false" ],
        "metadata": { "description": "Specify whether it is the primary nic" }
      },
      "nicResourceGroupName": {
        "type": "string",
        "defaultValue": "[resourceGroup().name]",
        "metadata": { "description": "The resource group the network interfaces are located" }
      },
      "tags": {
        "type": "object"
      }
    },
    "variables": {
      "blobUri": "[concat('https://', parameters('diagnosticStorageAccount'), '.blob.core.windows.net/')]",
      "adminPassword": {
        "reference": {
          "keyVault": {
            "id": "resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))"
          },
          "secretName": "parameters('userName')"
        }
      }
    },
    "resources": [
      {
        "type": "Microsoft.Compute/virtualMachines",
        "name": "[parameters('resourceName')]",
        "apiVersion": "[parameters('apiVersion')]",
        "location": "[parameters('location')]",
        "tags": "[parameters('tags')]",
        "properties": {
          "osProfile": {
            "computerName": "[parameters('resourceName')]",
            "adminUsername": "[parameters('userName')]",
            "adminPassword": "variables('adminPassword')",
            "windowsConfiguration": {
              "provisionVmAgent": "[parameters('provisionVmAgent')]"
            }
          },
          "hardwareProfile": {
            "vmSize": "[parameters('vmSize')]"
          },
          "storageProfile": {
            "imageReference": {
              "publisher": "[parameters('publisher')]",
              "offer": "[parameters('offer')]",
              "sku": "[parameters('sku')]",
              "version": "[parameters('version')]"
            },
            "osDisk": {
              "name": "[concat(parameters('resourceName'), '-vod01')]",
              "osType": "[parameters('osType')]",
              "caching": "[parameters('caching')]",
              "managedDisk": {
                "storageAccountType": "[parameters('diskStorageAccountType')]"
              },
              "createOption": "[parameters('createOption')]"
            }
          },
          "networkProfile": {
            "networkInterfaces": [
              {
                "properties": {
                  "primary": "[parameters('nic1IsPrimary')]"
                },
                "id": "[resourceId(parameters('nicResourceGroupName'), 'Microsoft.Network/networkInterfaces', parameters('nic1'))]"
              },
              {
                "properties": {
                  "primary": "[parameters('nic2IsPrimary')]"
                },
                "id": "[resourceId(parameters('nicResourceGroupName'), 'Microsoft.Network/networkInterfaces', parameters('nic2'))]"
              }
            ]
          },
          "diagnosticsProfile": {
            "bootDiagnostics": {
              "enabled": "[parameters('bootDiagnosticsEnabled')]",
              "storageUri": "[variables('blobUri')]"
            }
          }
        }
      }
    ]
  }
    